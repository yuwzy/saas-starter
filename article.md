# 記事管理機能 実装計画

## ゴール
- チーム単位で記事（タイトル・本文）を作成/閲覧/更新/削除できるフローを提供する。
- ダッシュボードから記事一覧・詳細・編集画面へ遷移できる一連のUIを整備し、権限のないユーザーは操作できないようにする。
- バリデーションとエラーハンドリングを統一し、UXを損なわない形で失敗時のフィードバックを返す。

## 現状と前提
- 既存DBは `users`, `teams`, `team_members`, `activity_logs`, `invitations` のみ。記事管理用のテーブルは未定義。
- ダッシュボード配下のルーティングは `app/(dashboard)` に集約されている。サーバーアクションやAPIルートはまだ記事向けに存在しない。
- shadcn/ui コンポーネント群とTailwindユーティリティを用いてUI構築する方針。
- 認証済みユーザーはチームに所属している想定なので、記事は `team_id` でマルチテナント管理する。

## 実装ステップ
1. **データモデルとマイグレーション**
   - `lib/db/schema.ts` に `articles` テーブルを追加。カラム例: `id`, `teamId`, `authorId`, `title`, `content`, `status`, `publishedAt`, `createdAt`, `updatedAt`。
   - `lib/db/migrations` に新しいマイグレーションファイルを作成し、Drizzleでテーブルを作成。`pnpm db:generate` → `pnpm db:migrate` をローカルで実行。
   - 必要であれば `lib/db/seed.ts` を更新し、テスト用記事データを投入可能にする。

2. **ドメインロジックの整備**
   - `lib/db/queries.ts` もしくは専用モジュールに記事取得/作成/更新/削除の関数を追加。`teamId` と `userId` でスコープを絞る。
   - 入出力の型を `zod` スキーマで定義し、フォーム・API双方で共通利用する。
   - 操作成功時に `activity_logs` へレコードを追加するか検討し、必要ならヘルパーを用意。

3. **API/サーバーアクションレイヤー**
   - `app/api/articles` 配下に REST エンドポイントを作成（一覧GET、作成POST、詳細GET/PUT/DELETE）。認証済みユーザーのチーム権限チェックを行う。
   - もしくはダッシュボード用にサーバーアクションを定義し、フォームから呼び出す。どちらを採用するかはUXとキャッシュ要件で判断。
   - エラーレスポンスを一貫させ、フロントで扱えるよう整形。

4. **UIルーティングとページ実装**
   - `app/(dashboard)/articles/page.tsx`: 記事一覧（タイトル、更新日時、アクションボタン）を表示。SWRまたはサーバーコンポーネントでデータ取得。
   - `app/(dashboard)/articles/new/page.tsx`: 作成フォーム。`Title` テキスト、`Content` リッチ or テキストエリア。送信後に詳細/一覧へ遷移。
   - `app/(dashboard)/articles/[articleId]/page.tsx`: 記事詳細。読みやすいレイアウトとアクションボタン（編集・削除）を配置。
   - `app/(dashboard)/articles/[articleId]/edit/page.tsx`: 編集フォーム。初期値を読み込み、更新後に詳細へ戻す。
   - 共通フォームコンポーネントを `components/articles/article-form.tsx` 等に切り出し、バリデーションエラー表示を統一。

5. **ナビゲーション統合と権限保護**
   - ダッシュボードのヘッダー/サイドバーに「Articles」リンクを追加。未ログイン・権限なしでアクセスした場合はリダイレクトまたはエラーハンドリングを実装。
   - ルート保護のため、既存の認証チェックロジックを利用して記事ページでもユーザーとチームの整合性を検証。

6. **UX向上と補助機能**
   - 削除時にConfirmダイアログを表示。`DropdownMenu` や `AlertDialog` を再利用。
   - 長文入力支援として Markdown エディタやプレビューが必要か検討（当面はテキストエリアに留め、将来拡張案に記載）。
   - 一覧で検索・ソートが必要か判断。まずは作成日時の降順表示を実装。

7. **QAとドキュメント整備**
   - `pnpm dev` で記事の作成→閲覧→編集→削除までのフローを手動検証。チームを跨いだアクセスが拒否されることを確認。
   - READMEやリリースノートに新しいマイグレーションファイル名と利用手順を追記。必要であればスクリーンショットを準備。

## 今後の拡張検討
- 記事の公開ステータスやタグ機能、外部公開URLの導入。
- 共同編集やコメント機能、履歴管理を追加する場合のスキーマ拡張。
- PlaywrightによるE2Eテスト整備（記事CRUDの回帰テスト）。

