---
name: code-review
description: Performs comprehensive code review following project coding conventions. Use when you need to review code changes, staged files, or specific files/directories for quality, security, and adherence to standards.
allowed-tools: Bash, Read, Grep, Glob
---

# Code Review Skill

このスキルは、プロジェクトのコーディング規約に基づいて包括的なコードレビューを実行します。品質、セキュリティ、保守性、パフォーマンスの観点から変更をチェックします。

## Instructions

このスキルを実行する際は、以下の手順に従ってください:

### 1. レビュー対象の特定

レビュー対象に応じて、以下のいずれかを実行:

#### ステージされた変更をレビューする場合

```bash
git diff --staged --name-only
git diff --staged
```

#### 特定のファイル/ディレクトリをレビューする場合

ユーザーが指定したファイルまたはディレクトリを対象とします。

#### 最近のコミットをレビューする場合

```bash
git log --oneline -1
git show HEAD --name-only
git show HEAD
```

### 2. コーディング規約の確認

レビューを開始する前に、プロジェクトのコーディング規約を確認:

- [docs/CODING_CONVENTIONS.md](../../../docs/CODING_CONVENTIONS.md) - 包括的なコーディング規約
- [CLAUDE.md](../../../CLAUDE.md) - プロジェクト全体のアーキテクチャガイドライン

### 3. レビュー項目

以下のカテゴリに沿ってコードをレビューします:

#### 3.1 アーキテクチャ原則

**API-First Design:**

- ✅ すべてのデータ変更が API ルート経由で行われているか
- ✅ Server Actions がデータベースに直接アクセスしていないか
- ✅ Server Actions が API ルートを呼び出しているか

**Data Access Layer:**

- ✅ SQL クエリが `lib/db/queries.ts` または `lib/db/*-queries.ts` に抽象化されているか
- ✅ API ルート、Server Actions、ページコンポーネントで直接 `db.*` を呼び出していないか
- ✅ Drizzle のリレーショナルクエリ構文 (`db.query.*`) を使用しているか

#### 3.2 TypeScript / 型安全性

- ✅ `any` 型を使用していないか（`unknown` + 型ガードを推奨）
- ✅ Drizzle スキーマから型を推論しているか
- ✅ 複合型が適切にエクスポートされているか
- ✅ 名前付きエクスポート/インポートを使用しているか（default export は避ける）
- ✅ 型インポートに `import type` を使用しているか

#### 3.3 React コンポーネント

- ✅ Server Components がデフォルトになっているか
- ✅ `'use client'` が必要な場合のみ使用されているか
- ✅ Props に明示的な型定義（interface）があるか
- ✅ 名前付き関数でエクスポートしているか
- ✅ Tailwind + セマンティックトークンを使用しているか
- ✅ `cn()` ユーティリティで className をマージしているか
- ✅ 複数バリアントがある場合 `cva` を使用しているか

#### 3.4 データベースクエリ

- ✅ すべてのクエリ関数に JSDoc コメントがあるか
- ✅ クエリ関数が適切に命名されているか (`get*`, `create*`, `update*`, `delete*`, `can*`)
- ✅ エラーハンドリングが適切か
- ✅ N+1 クエリ問題がないか
- ✅ インデックスが適切に使用されているか（パフォーマンス）

#### 3.5 API ルート

- ✅ 認証チェック (`getUser()`) が実装されているか
- ✅ 認可チェック（チーム権限など）が実装されているか
- ✅ Zod でリクエストボディをバリデーションしているか
- ✅ 適切な HTTP ステータスコードを使用しているか
- ✅ 一貫したエラーレスポンス形式 (`{ error: string }`) を使用しているか
- ✅ JSDoc コメントがあるか
- ✅ クエリ関数を呼び出しているか（直接 DB アクセスしていないか）

#### 3.6 Server Actions

- ✅ `'use server'` ディレクティブがあるか
- ✅ API ルートを呼び出しているか（直接 DB アクセスしていないか）
- ✅ Zod でバリデーションしているか
- ✅ `ActionState` 型を使用しているか
- ✅ JSDoc コメントがあるか
- ✅ エラーハンドリングが適切か
- ✅ `revalidatePath()` を適切に使用しているか

#### 3.7 セキュリティ

- ✅ OWASP Top 10 の脆弱性がないか:
  - SQL インジェクション（生 SQL を避ける）
  - XSS（`dangerouslySetInnerHTML` を避ける）
  - 認証の不備（JWT 有効期限チェック）
  - 機密データの露出（`.env` ファイルなど）
- ✅ ユーザー入力が適切にバリデーションされているか
- ✅ 認可チェックが適切に実装されているか
- ✅ パスワードや機密情報がログに出力されていないか

#### 3.8 コードスタイル

- ✅ 命名規則に従っているか:
  - ファイル: `kebab-case`
  - 変数/関数: `camelCase`
  - コンポーネント: `PascalCase`
  - データベース: `lower_snake_case`
- ✅ 2 スペースインデント、シングルクォートを使用しているか
- ✅ パスエイリアス `@/` を使用しているか
- ✅ 不要なコメントがないか（自明なコードにコメントは不要）
- ✅ JSDoc が適切に記述されているか

#### 3.9 パフォーマンス

- ✅ 不要な再レンダリングがないか
- ✅ 大量データの効率的な処理（ページネーション、遅延ロード）
- ✅ 画像の最適化（Next.js Image コンポーネント）
- ✅ バンドルサイズへの影響

#### 3.10 保守性

- ✅ 関数が単一責任原則に従っているか
- ✅ DRY 原則に従っているか（重複コードがないか）
- ✅ マジックナンバーを避けているか（定数を使用）
- ✅ 複雑なロジックが適切にコメントされているか
- ✅ テスタビリティ（関数が純粋か、副作用が最小限か）

### 4. レビュー結果の報告

以下の形式でレビュー結果を報告します:

```markdown
# Code Review Report

## Summary

[変更の概要と全体的な評価]

## Critical Issues (修正必須)

[セキュリティ、バグ、アーキテクチャ違反など、必ず修正すべき問題]

- ❌ **[ファイル名:行番号]** - [問題の説明]
  - **理由**: [なぜ問題なのか]
  - **推奨修正**: [具体的な修正方法]

## Warnings (推奨修正)

[コーディング規約違反、パフォーマンス問題など、修正を推奨する問題]

- ⚠️ **[ファイル名:行番号]** - [問題の説明]
  - **理由**: [なぜ推奨されないのか]
  - **推奨修正**: [具体的な修正方法]

## Suggestions (改善案)

[より良い実装方法、リファクタリング提案など]

- 💡 **[ファイル名:行番号]** - [提案の説明]
  - **理由**: [なぜ改善になるのか]
  - **例**: [具体的なコード例]

## Good Practices

[良い実装やベストプラクティスに従っている点]

- ✅ **[ファイル名:行番号]** - [良い点の説明]

## Overall Assessment

- **Architecture**: [評価とコメント]
- **Security**: [評価とコメント]
- **Performance**: [評価とコメント]
- **Maintainability**: [評価とコメント]
- **Code Style**: [評価とコメント]

## Next Steps

[推奨される次のアクション]
```

### 5. レビューのスコープ

#### 軽量レビュー（Quick Review）

- コーディング規約への準拠
- 明らかなバグやセキュリティ問題
- 型安全性

#### 標準レビュー（Standard Review）

- 軽量レビューの内容
- アーキテクチャ原則への準拠
- パフォーマンスの基本チェック
- 保守性

#### 詳細レビュー（Thorough Review）

- 標準レビューの内容
- セキュリティの詳細チェック（OWASP Top 10）
- パフォーマンスの詳細分析
- エッジケースの検討
- テスタビリティ

ユーザーが指定しない場合は、**標準レビュー**を実行します。

## Examples

### Example 1: ステージされた変更のレビュー

```bash
# 変更ファイルを確認
git diff --staged --name-only

# 変更内容を確認
git diff --staged

# 各ファイルを読み込んでレビュー
# (Read ツールを使用)
```

### Example 2: 特定ファイルのレビュー

```bash
# ファイルを読み込んでレビュー
# (Read ツールを使用して app/api/articles/route.ts を読み込む)
```

### Example 3: 特定ディレクトリ内の全ファイルのレビュー

```bash
# ディレクトリ内のファイルを列挙
# (Glob ツールを使用して lib/db/*.ts を検索)

# 各ファイルを読み込んでレビュー
# (Read ツールを使用)
```

## Important Notes

1. **コンテキストを理解する** - 変更の目的や背景を考慮してレビューする
2. **建設的なフィードバック** - 問題点だけでなく、具体的な改善案を提供する
3. **優先順位を明確にする** - Critical Issues（修正必須）と Suggestions（改善案）を区別する
4. **コーディング規約を基準にする** - プロジェクトの規約に従っているかを最優先する
5. **セキュリティを最優先** - セキュリティ問題は必ず Critical Issues として報告する
6. **実用的なアドバイス** - 理論だけでなく、実際のコード例を提示する
7. **良い点も指摘する** - 問題点だけでなく、良い実装も積極的に評価する

## Related Files

このスキルは以下のドキュメントを参照します:

- [docs/CODING_CONVENTIONS.md](../../../docs/CODING_CONVENTIONS.md) - コーディング規約
- [CLAUDE.md](../../../CLAUDE.md) - プロジェクトガイドライン
